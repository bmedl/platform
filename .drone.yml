kind: pipeline
type: docker
name: app

steps:
  - name: test_backend
    image: python:3.7.4
    commands:
      - cd backend
      - pip install -r requirements.txt
      - pytest

---
kind: pipeline
type: ssh
name: deploy

workspace:
  base: /tmp/drone-bmedl
  path: src

server:
  host: 172.17.0.1
  user:
    from_secret: ssh_user
  password:
    from_secret: ssh_password

steps:
  - name: deploy
    commands:
      - docker-compose down
      - docker-compose --build -d up

depends_on:
  - app